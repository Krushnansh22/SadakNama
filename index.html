<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoadTrack - Public Accountability Portal</title>
    
    <!-- Pico CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
        }

        .search-box input {
            margin: 0;
            background: white;
            border: none;
            padding: 0.7rem;
        }

        .stats {
            display: flex;
            gap: 1.5rem;
            color: white;
            font-size: 0.9rem;
        }

        .stats span {
            white-space: nowrap;
        }

        .stats strong {
            font-weight: bold;
            color: #ffd700;
        }

        /* Map */
        #map {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        /* Loading */
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: white;
            padding: 2rem 3rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            font-size: 1.2rem;
        }

        #loading.hidden {
            display: none;
        }

        /* Sidebar */
        #sidebar {
            position: fixed;
            top: 80px;
            right: 0;
            bottom: 0;
            width: 400px;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            z-index: 1500;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            padding: 2rem;
        }

        #sidebar.visible {
            transform: translateX(0);
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }

        .close-btn:hover {
            background: #dc2626;
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .status-completed {
            background: #22c55e;
            color: white;
        }

        .status-construction {
            background: #eab308;
            color: black;
        }

        .status-delayed {
            background: #ef4444;
            color: white;
        }

        .detail-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-section h3 {
            font-size: 0.9rem;
            color: #667eea;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .detail-section p {
            margin: 0.3rem 0;
            color: #374151;
        }

        .detail-section strong {
            color: #111827;
        }

        .issues-badge {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                height: 60vh;
                top: auto;
                bottom: 0;
                transform: translateY(100%);
            }

            #sidebar.visible {
                transform: translateY(0);
            }

            .stats {
                display: none;
            }

            .header-content {
                flex-direction: column;
            }

            .search-box {
                max-width: 100%;
            }
        }

        /* Legend */
        .legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.85rem;
        }

        .legend h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.3rem 0;
        }

        .legend-line {
            width: 30px;
            height: 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">üõ£Ô∏è RoadTrack</div>
            <div class="search-box">
                <input type="search" id="searchInput" placeholder="Search by road name or district..." />
            </div>
            <div class="stats">
                <span>üìä Projects: <strong id="totalProjects">0</strong></span>
                <span>üí∞ Investment: <strong id="totalInvestment">‚Çπ0</strong></span>
                <span>‚ö†Ô∏è Issues: <strong id="totalIssues">0</strong></span>
            </div>
        </div>
    </header>

    <!-- Loading -->
    <div id="loading">
        üîÑ Loading projects...
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Legend -->
    <div class="legend">
        <h4>Road Status</h4>
        <div class="legend-item">
            <div class="legend-line" style="background: #22c55e;"></div>
            <span>Completed</span>
        </div>
        <div class="legend-item">
            <div class="legend-line" style="background: #eab308;"></div>
            <span>Under Construction</span>
        </div>
        <div class="legend-item">
            <div class="legend-line" style="background: #ef4444;"></div>
            <span>Delayed</span>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar">
        <button class="close-btn" onclick="closeSidebar()">‚úï Close</button>
        <div id="sidebarContent">
            <!-- Content will be populated by JavaScript -->
        </div>
    </aside>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Global variables
        let map;
        let allProjects = [];
        let polylines = {};

        // Color mapping for road status
        const statusColors = {
            'Completed': '#22c55e',
            'Under Construction': '#eab308',
            'Delayed': '#ef4444'
        };

        // Initialize map
        function initMap() {
            map = L.map('map').setView([21.1458, 79.0882], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // Fetch and display projects
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                
                if (data.success) {
                    allProjects = data.projects;
                    displayProjects(allProjects);
                    updateStats(allProjects);
                    document.getElementById('loading').classList.add('hidden');
                } else {
                    alert('Failed to load projects: ' + data.error);
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                alert('Failed to connect to server. Make sure main.py is running!');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Display projects on map
        function displayProjects(projects) {
            // Clear existing polylines
            Object.values(polylines).forEach(p => map.removeLayer(p));
            polylines = {};

            projects.forEach(project => {
                const color = statusColors[project.status] || '#6b7280';
                const coordinates = project.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                const polyline = L.polyline(coordinates, {
                    color: color,
                    weight: 5,
                    opacity: 0.8
                }).addTo(map);

                polyline.on('click', () => {
                    showProjectDetails(project);
                    polyline.setStyle({ weight: 8, color: '#3b82f6' });
                    setTimeout(() => {
                        polyline.setStyle({ weight: 5, color: color });
                    }, 2000);
                });

                polylines[project.id] = polyline;
            });
        }

        // Show project details in sidebar
        function showProjectDetails(project) {
            const statusClass = project.status.toLowerCase().replace(' ', '-');
            
            const html = `
                <h2 style="margin-top: 2rem;">${project.road_name}</h2>
                <span class="status-badge status-${statusClass}">${project.status}</span>
                ${project.issues_reported > 0 ? `<span class="issues-badge">${project.issues_reported} Issues Reported</span>` : ''}
                
                <div class="detail-section">
                    <h3>üìã Project Details</h3>
                    <p><strong>District:</strong> ${project.district}</p>
                    <p><strong>Description:</strong> ${project.description}</p>
                    <p><strong>Total Cost:</strong> ${project.total_cost}</p>
                </div>

                <div class="detail-section">
                    <h3>‚è±Ô∏è Timeline</h3>
                    <p><strong>Start Date:</strong> ${project.start_date}</p>
                    <p><strong>Target Completion:</strong> ${project.completion_date}</p>
                </div>

                <div class="detail-section">
                    <h3>üë∑ Construction</h3>
                    <p><strong>Contractor:</strong> ${project.contractor}</p>
                    <p><strong>Maintenance Firm:</strong> ${project.maintenance_firm}</p>
                </div>

                <div class="detail-section">
                    <h3>üëî Accountability</h3>
                    <p><strong>Minister Involved:</strong> ${project.minister_involved}</p>
                    <p><strong>Approving Official:</strong> ${project.approving_official}</p>
                </div>
            `;

            document.getElementById('sidebarContent').innerHTML = html;
            document.getElementById('sidebar').classList.add('visible');
        }

        // Close sidebar
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('visible');
        }

        // Update statistics
        function updateStats(projects) {
            document.getElementById('totalProjects').textContent = projects.length;
            
            const totalIssues = projects.reduce((sum, p) => sum + p.issues_reported, 0);
            document.getElementById('totalIssues').textContent = totalIssues;
            
            // Calculate total investment (simplified)
            const costs = projects.map(p => {
                const match = p.total_cost.match(/(\d+)/);
                return match ? parseInt(match[1]) : 0;
            });
            const total = costs.reduce((sum, cost) => sum + cost, 0);
            document.getElementById('totalInvestment').textContent = `‚Çπ${total} Cr`;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            if (query.length < 2) {
                displayProjects(allProjects);
                return;
            }

            const filtered = allProjects.filter(p => 
                p.road_name.toLowerCase().includes(query) ||
                p.district.toLowerCase().includes(query) ||
                p.contractor.toLowerCase().includes(query)
            );

            displayProjects(filtered);

            // If exactly one result, zoom to it
            if (filtered.length === 1) {
                const coords = filtered[0].geometry.coordinates;
                const latLngs = coords.map(c => [c[1], c[0]]);
                map.fitBounds(latLngs, { padding: [50, 50] });
                showProjectDetails(filtered[0]);
            }
        });

        // Initialize on page load
        window.onload = () => {
            initMap();
            loadProjects();
        };
    </script>
</body>
</html>